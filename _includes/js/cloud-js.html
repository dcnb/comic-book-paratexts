{%- comment -%}

    Generates a subject cloud using js to process the terms for display on "cloud" layout.
    Requires CB's array_count_uniq.rb plugin!

{%- endcomment -%}
{% if site.data.theme.browse-child-objects == true %}
{%- assign items = site.data[site.metadata] | where_exp: 'item','item.objectid' -%}
{% else %}
{%- assign items = site.data[site.metadata] | where_exp: 'item','item.objectid and item.parentid == nil' -%}
{% endif %}
{%- assign termsMin = include.min | plus: 0 | default: 1 -%}
{%- assign cloud_id = include.id | default: "cloud" -%}
{%- assign cloud-fields = include.fields | split: ";" -%}

{%- assign terms = "" -%}

{% comment %} Loop through each field in cloud-fields {% endcomment %}
{%- for c in cloud-fields -%}
  
  {% comment %} Collect all terms for the current field, joined with ";" {% endcomment %}
  {%- assign new_terms = items | map: c | join: ";" -%}
  
  {% comment %} Split the terms into an array to process them individually {% endcomment %}
  {%- assign split_terms = new_terms | split: ";" -%}

  {% comment %} Loop through each individual term {% endcomment %}
  {%- for term in split_terms -%}
    
    {% comment %} Remove leading and trailing whitespace {% endcomment %}
    {%- assign term = term | strip -%}

    {% comment %} Ensure the term is not empty or nil before processing {% endcomment %}
    {%- if term != "" and term != nil -%}
      
      {% comment %} Prefix the term with its field name {% endcomment %}
      {%- assign labeled_term = c | append: ":" | append: term -%}

      {% comment %} Append the labeled term to the terms list {% endcomment %}
      {%- assign terms = terms | append: ";" | append: labeled_term -%}

    {%- endif -%}

  {%- endfor -%}

{%- endfor -%}

{% comment %} Process terms: lowercase, split, count unique, sort, and filter by minimum threshold {% endcomment %}
{%- assign uniqTerms = terms | downcase | split: ";" | array_count_uniq | sort | where_exp: 't', 't[1] >= termsMin' -%}

{% comment %} Debugging output to verify term formatting {% endcomment %}
<pre>{{ uniqTerms | join: ", " }}</pre>

<script>
(function(){    
    /* subject terms + count */
    var terms = [
        {% for t in uniqTerms %}[{{ t[0] | jsonify }}, {{ t[1] | jsonify }}]{% unless forloop.last %}, {% endunless %}{% endfor %}
    ];

    {% if include.stopwords %}/* apply stopwords */
    var stopWords = {{ include.stopwords | downcase | split: ';' | jsonify }};
    terms = terms.filter(function(a) { return stopWords.indexOf(a[0]) < 0;});{% endif %}
    /* calculate max size */
    var counts = terms.map(function(obj){ return obj[1]; });
    var countMax = counts.reduce(function(a, b) { return Math.max(a, b); });
    var cloud = document.getElementById("{{ cloud_id }}");
    {% if include.shuffle == true %}
    /* Fisher-Yates shuffle https://bost.ocks.org/mike/shuffle/ */
    function shuffle(array) {
        var m = array.length, t, i;
        while (m) {
            i = Math.floor(Math.random() * m--);
            t = array[m];
            array[m] = array[i];
            array[i] = t;
        }
        return array;
    }
    {% endif %}

    function mapSize(x) { return Math.round(x * 9 / countMax + 1); }
    /* create cloud */
    function makeGrid(array) {
        var i, size;
        var items = "";
        {% if include.shuffle == true %}shuffle(array);{% endif %}
        for (i = 0; i < array.length; i++) {
            size = mapSize(array[i][1]);
            items += '<a class="btn btn-{{ include.button | default: "outline-primary" }} m-2 tagcloud' + size + '" href="{{ "/search/index.html" | relative_url }}?q=' + encodeURIComponent(array[i][0]) + '" >' + array[i][0].split(":")[1] + '</a>';
        }
        cloud.innerHTML = items;
    }
    makeGrid(terms);

})();
</script>
